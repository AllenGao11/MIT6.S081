# 6.6 usertrap函数

usertrap函数是位于trap.c文件的一个函数。

![](../.gitbook/assets/image%20%28243%29.png)

既然我们已经运行在C代码中，接下来，我在gdb中输入tui enable打开对于C代码的展示。

![](../.gitbook/assets/image%20%28244%29.png)

我们现在在一个更加正常的世界中，我们正在运行C代码，应该会更容易理解。我们仍然会读写一些有趣的控制寄存器，但是环境比起trap frame来说会少了很多晦涩。

有很多原因都可以让代码执行进入到usertrap函数中来，比如系统调用，运算时除以0，使用了一个未被映射的虚拟地址，或者是设备中断。usertrap某种程度上存储并恢复硬件状态，但是它也需要检查触发trap的原因，已确定相应的处理方式，我们在执行usertrap的过程中会同时看到这两个行为。

接下来，让我们一步步执行usertrap函数。它做的第一件事情是更改STVEC寄存器。取决于trap是来自于用户空间还是内核空间，实际上XV6处理trap的方法是不一样的。目前为止，我们只讨论过当trap是由用户空间发起时会发生什么。如果trap从内核空间发起，将会是一个非常不同的处理流程，因为从内核发起的话，程序已经在使用kernel page table。所以当trap发生时，程序执行仍然在内核的话，很多处理都不存在。

所以，在内核中执行任何操作之前，usertrap中先将STVEC指向了kernelvec变量，这是内核trap处理代码的位置，而不是用户代码trap处理代码的位置。



