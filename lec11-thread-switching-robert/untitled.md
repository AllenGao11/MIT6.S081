# Untitled

我们今天的课程会讨论线程，以及XV6是如何完成线程切换。这节课与之前介绍系统调用，Interrupt，page table和锁的课程一样，都是介绍XV6底层实现的课程。今天我们讨论的是XV6是如何在多个进程之间完成切换。

线程切换的最根本原因是，人们希望他们的计算机在同一时间不只完成一件任务，有可能计算机正在执行分时复用的任务，例如MIT的公共计算机系统Athena允许多个用户同时登陆，并运行各自的进程。甚至在一个单用户的计算机上或者在你的iphone上，你会运行多个进程，并期望计算机完成所有的任务而不仅仅是一个任务。

人们想要支持多个任务的另一个原因是，这可以让程序的结构变得简单。线程在有些场合可以帮助程序员将代码以简单优雅的方式进行组织，并减少复杂度。实际上在第一个lab中prime number部分，通过多个进程可以更简单，方便，优雅的组织代码。

最后一个使用多线程的原因是为了通过并行运算，在多核CPU计算机上获得更快的处理速度。所以常见的方式是将你的程序进行拆分，并使用线程在不同的CPU核上运行程序的不同部分。如果你足够幸运的话，你可以将你的程序拆分并在4个CPU核上通过4个线程运行你的程序，同时你也可以获取4倍的程序运行速度。你可以认为XV6就是一个多核并行运算的程序。 

所以，线程可以认为是，当你有多个任务时，为了简化编程的一种抽象。一个线程可以认为是单个串行执行代码的单元。如果你写了一个程序只是按顺序的一个个执行任务，那么你可以认为这个程序就是个单线程程序。这是对于线程的一个宽松的定义，人们对于线程有很多不同的定义。在这里，我们认为线程就是单个串行的代码执行。当你只使用一个CPU来运行你的程序时，你就得到了线程。它就是以普通的方式一个接一个的执行指令。

![](../.gitbook/assets/image%20%28472%29.png)

我们通常会说到线程具有状态，因为我们会想要保持线程的状态，并在之后恢复它。正确理解线程状态的方式是，它包含了程序计数器（Program Counter），因为它是对指令的执行单元，我们会关心它正在执行哪个位置的指令。同时，我们也关心处理器中为了支持代码执行的其他部分， 这意味着线程的状态还包含了编译器用来保存变量的寄存器。同时，根据编译器生成代码的方式，线程的状态还包含了stack。所以通常来说每个线程都有属于自己的stack，stack记录了函数调用的记录，并反映了当前线程的执行点。

![](../.gitbook/assets/image%20%28494%29.png)

线程系统的工作就是管理多个线程的运行。我们可能会启动成百上千个线程，而线程系统的工作就是弄清楚如何管理这些线程并让它们都能运行。

多线程的运行主要有两个策略，第一个策略是在多核处理器上使用多个CPU，每个CPU都可以运行一个线程，如果你有4个CPU，那么每个CPU可以运行一个线程。每个线程自动的根据所运行在CPU就有了程序计数器和寄存器。

但是如果你只有4个CPU，却有上千个线程，每个CPU都运行一个线程就不能解决这里的问题。

