# 14.3 File system结构

这一节我们来看一下文件系统的结构。文件系统究竟维护了什么样的结构来实现我们上一节介绍的API？

首先，最重要的可能就是inode，这是代表一个文件的对象，并且它不依赖文件名。实际上，inode是通过自身的序列号区分的，这里的序列号就是个整数。所以文件系统内部通过一个数字，而不是通过文件路径名引用inode。同时，基于之前的讨论，inode必须有一个link count来跟踪指向这个inode的文件名的数量。一个文件（inode）只能在link count为0的时候才被删除。实际上可能会更加复杂，实际中还有一个openfd count，也就是当前打开了文件的文件描述符计数。一个文件只能在这两个计数器都为0的时候才能被删除。

![](../.gitbook/assets/image%20%28592%29.png)

同时基于之前的讨论，我们也知道write和read都没有针对文件的offset参数，所以文件描述符必然自己悄悄维护了对于文件的offset。

![](../.gitbook/assets/image%20%28596%29.png)

文件系统中核心的数据结构就是inode和file descriptor。后者主要与用户进程进行交互。

尽管文件系统的API很相近，内部的实现可能非常不一样。但是很多文件系统都有类似的结构。因为文件系统还挺复杂的，所以最好将文件按照层级来放置。可以这样看：

* 在最底层是磁盘，也就是一些实际保存数据的存储设备，正是这些设备提供了持久化存储。
* 在这之上是buffer cache或者说block cache，这些cache可以避免频繁的读写磁盘。这里我们将磁盘中的数据保存在了内存中。
* 为了保证持久性，再往上通常会有一个logging层。许多文件系统都有某种形式的logging，我们下节课会讨论这部分内容，所以今天我就跳过它的介绍。
* 在logging层之上，XV6有inode cache，这主要是为了同步（synchronization），我们稍后会介绍。inode通常小于一个磁盘块，所以inode通常会打包存储于一个磁盘块中。为了为单个inode提供同步，XV6维护了inode cache。
* 再往上就是inode本身了。它实现了read/write。
* 再往上，就是文件名，和文件描述符操作。

![](../.gitbook/assets/image%20%28591%29.png)

不同的文件系统组织方式和每一层可能都略有不同，有的时候分层也没有那么严格，即使在XV6中分层也不是很严格，但是从概念上来说这里的结构对于理解文件系统还是有帮助的。实际上所有的文件系统都有组件对应这里不同的分层，例如buffer cache，logging，inode和路径名。

接下来，让我从简单的介绍最底层开始，也即是存储设备。实际中有非常非常多不同类型的存储设备，这些设备的区别在于性能，容量，数据保存的期限。其中两种最常见，并且你们应该也挺熟悉的是SSD和HDD。这两类存储虽然有着不同的性能，但是都在合理的成本上提供了大量的存储空间。SSD通常是0.1到1毫秒的访问时间，而HDD通常是在10毫秒量级完成读写一个磁盘块。

![](../.gitbook/assets/image%20%28594%29.png)

这里有些术语有点让人困惑，它们是sectors和blocks。

* sector通常是磁盘驱动可以读写的最小单元，它过去通常是512字节。
* block通常是操作系统或者文件系统视角的数据。它由文件系统定义，在XV6中它是1024字节。所以XV6中一个block对应两个sector。通常来说一个block对应了一个或者多个sector。

有的时候，人们也将磁盘上的sector称为block。所以这里的术语也不是很精确。

这些存储设备连接到了总线之上，总线也连接了CPU和内存。一个文件系统运行在CPU上，将内部的数据存储在内存，同时也会以读写block的形式读写SSD或者HDD。所以这里的接口还是挺简单的，这有read/write，然后以block编号作为参数。虽然我们这里描述的过于简单了，但是实际的接口大概就是这样。

![](../.gitbook/assets/image%20%28589%29.png)

在内部，SSD和HDD工作方式完全不一样，但是对于硬件的抽象屏蔽了这些差异。通常来说有一些标准的协议，例如PCIE，磁盘驱动使用这些协议与磁盘交互，从磁盘驱动网上，大部分的磁盘看起来都一样，你可以提供block编号，在驱动中通过写设备的控制寄存器，然后设备就会完成相应的工作。这是从一个文件系统的角度的描述。尽管不同的存储设备有着非常不一样的属性，从驱动的角度来看，你可以以大致相同的方式对它们进行编程。

有关存储设备我们就说这么多。

