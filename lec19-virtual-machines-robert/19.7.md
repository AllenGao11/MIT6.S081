# 19.7

今天的[论文](https://pdos.csail.mit.edu/6.828/2020/readings/belay-dune.pdf)，利用了上一节介绍的对于虚拟机的硬件支持，但是却将其用作其他的用途。这是这篇论文的有趣之处，它利用了这种完全是为了虚拟机而设计的硬件，但是却用来做一些与虚拟机无关的事情。

从一个全局的视角来看这篇论文的内容，它只是想要实现普通的进程。所以现在我们的场景是在一个Linux而不是虚拟机中，但是硬件中又存在VT-x。我们假设我们加载了DUNE的可加载模块到Linux中，所以DUNE软件作为kernel的一部分运行在Supervisor mode，除此之外，内核的大部分还是Linux。

因为我们这里会运行Linux进程，所以我们期望这里支持的抽象是进程，以及包括系统调用在内的各种Linux进程可以做的事情。但是我们想要使用VT-x硬件来使得普通的进程可以做一些额外的事情。DUNE会运行这些进程，或者说允许一个进程切换到DUNE模式，这意味着，与其只是被Page Table保护和隔离，现在这个进程完全被VT-x机制隔离开了。所以现在进程有了一套完整的虚拟控制寄存器，例如CR3，因此也会有属于自己的Page Table，因为这些进程会运行在non-root Supervisor mode，所以它可以在虚拟状态信息上执行所有的privileged指令，这是由VT-x实现的。所以被DUNE管理的进程可以做的一个关键事情是，通过属于自己的CR3寄存器，设置好属于自己的Page Table。当然DUNE为这个进程控制了EPT。而EPT会被设置的只包含这个进程相关的内存。所以进程可以向CR3寄存器写入任意的Page Table地址，但是因为MMU会在翻译完正常的Page Table之后再将地址送到EPT去翻译，所以进程不能从分配给它的内存中逃逸。所以进程并不能修改其他进程或者kernel的内存，它只是有了一种更灵活的设置自己内存的方式。所以，DUNE管理的进程可以拥有属于自己的Page Table，基本上它需要有属于自己的Page Table，否则它是不能工作的。

![](../.gitbook/assets/image%20%28747%29.png)

DUNE管理的进程可以做的另一件事情是，可以拥有Supervisor mode和User mode，就像一个小的虚拟机一样。并且可以保护运行在Supervisor mode的代码，不受运行在User mode的代码影响。

![](../.gitbook/assets/image%20%28746%29.png)

论文中提到了可以基于 Dune做的两件事情：能够在硬件层面支持Supervisor mode和User mode使得进程可以在自己的User mode中运行未被信任的插件代码。这里的主进程或许是一个网页浏览器，你可以下载各种各样的插件并运行在网页浏览器中，或许是一个新的视频解码器，一个新的广告拦截插件等等。但是我们并不完全信任这个插件，所以我们希望能够在权限受限制的前提下运行它。在一个普通的Linux中也可以达到这个目的，但是会比较麻烦。而通过DUNE，我们可以在User mode下运行插件，而网页浏览器运行在进程的Supervisor mode下，并且可以为User mode配置一个不同的Page Table，因为它可以修改CR3寄存器。这使得进程可以运行这里的未被信任的插件代码，并且只能访问网页流量器的某些内存Page，所以即使插件是恶意的，它也不能任意的读写主浏览器的内存。User代码或许会想要执行系统调用，但是这些提供调用会通过trap走到进程的Supervisor mode，而不是Linux，所以这里的插件代码或许会认为自己调用了fork/read/write等系统调用，但是实际上这里尝试运行的系统调用通过trap走到了进程对应的网页浏览器，网页浏览器可以做任意的事情，它可以选择执行或者不执行系统调用。所以现在网页浏览器对于插件代码有了完整的控制能力。



