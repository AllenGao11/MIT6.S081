# 19.6 硬件对虚拟机的支持

接下来我将讨论硬件对于虚拟机的支持，这里特指的就是Intel的VT-x。为什么Intel和其他的硬件厂商会为虚拟机提供直接的硬件支持呢？

* 首先虚拟机应用的非常广泛，大量的客户都在使用虚拟机
* 其次，我们刚刚描述的Trap and Emulate经常会涉及到大量高成本的trap，所以这种方案并不特别的有效。
* 第三个原因或许就没那么有趣了。尽管RISC-V非常适合Trap and Emulate方案，Intel的x86处理器拥有一些非常具体的功能使得它可以支持虚拟化，但是又困难重重。所以Intel也有动力来修复这的问题，因为它的很多客户想要运行VMM。

![](../.gitbook/assets/image%20%28739%29.png)

这里硬件上的支持是为了让你能够构建可以运行的更快的虚拟机，同时也更容易实现一个虚拟机。这里硬件上的支持已经存在了或许10年了，并且现在在构建虚拟机时使用的非常非常广泛。这里基本的策略是，在Trap and Emulate方案中，VMM会为每个Guest在软件中保存一份虚拟状态信息，而现在，这些虚拟状态信息会硬件中支持。这样使得Guest软件可以直接执行privileged指令来修改保存在硬件中的虚拟寄存器，而不是通过trap走到VMM来修改VMM中保存在软件中的虚拟寄存器。所以这里的目标是Guest可以在不触发trap的前提下，执行privileged指令。

现在我们还是有一个VMM在内核空间，并且Guest运行在用户空间，但是在硬件中保存了STVEC，SCAUSE等等其他寄存器。当我们使用这种新的硬件支持的方案时，我们的VMM会使用这些寄存器的真实版本。当VMM通知硬件切换到Guest mode时，硬件会有一套完全独立，在Guest mode下使用的寄存器。所以Guest mode下可以读写这套寄存器，但是读写的是Guest在硬件中对于寄存器的拷贝，而不是真实的寄存器。

![](../.gitbook/assets/image%20%28740%29.png)

