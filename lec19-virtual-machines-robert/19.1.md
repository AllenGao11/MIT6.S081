# 19.1 Why Virtual Machine?

今天讨论的话题是虚拟机。今天的内容包含三个部分:

* 第一个部分是trap and emulate virtualization，这部分会介绍如何在RISC-V和QEMU上构建属于自己的虚拟机方案。
* 接下来还会描述最近在硬件上对于虚拟化的支持。
* 最后是讨论一下今天的[论文](https://pdos.csail.mit.edu/6.828/2020/readings/belay-dune.pdf)，它使用了第二部分中硬件上的支持。

首先，什么是虚拟机？你可以认为这是对于计算机的一种模拟，模拟的足够能运行一个操作系统。QEMU可以认为是虚拟机的一个例子（注，QEMU应该是属于VMM/Hypervisor）。

这里在最底层，位于硬件之上存在一个Virtual Machine Monitor（VMM），它或多或少的替代了标准的操作系统内核。VMM的工作是模拟多个计算机用来运行Guest操作系统。VMM之上，如果对比一个操作系统的架构图应该是用户空间，但是现在是叫做Guest空间。所以在今天的图里面，上面是Guest空间，下面是Host空间。

![](../.gitbook/assets/image%20%28723%29.png)

在Guest空间，会有一个或者多个Guest操作系统内核，或许其中一个是Linux kernel。这里的Linux kernel会觉得自己就是个普通的内核，并在之上运行一堆用户进程，例如VI，C Compiler。我们或许还有另一个Guest系统运行了其他的例如Windows的操作系统，同时也包含了Windows用户进程。所以，在Host空间运行的是VMM，在Guest空间运行的是普通的操作系统。除此之外，在Guest空间我们还将大量讨论Guest Supervisor Mode，也就是Guest操作系统内核运行的模式，以及Guest User Mode。

![](../.gitbook/assets/image%20%28724%29.png)

VMM的主要目标是提供对计算机的模拟，这样你可以不做修改的启动普通的Linux，普通的Windows系统，并运行在虚拟机内，并且不用担心任何奇怪的事情会发生。所以，VMM必须要能够完全按照实际硬件的行为来模拟Guest Supervisor Mode和Guest User Mode，尽管实际上不可能完全一样。所以我们将会讨论VMM对于这两种模式的模拟。

那么人们为什么会想要使用虚拟机呢？实际中有很多原因会在一个计算机上运行多个独立的操作系统。在一个大公司里面，你需要大量的服务器，例如DNS，Firewall等等，但是每个服务器并没有使用太多的资源，所以单独为这些服务器购买物理机器有点浪费，但是将这些低强度的服务器以虚拟机的形式运行在一个物理机上可以节省时间和资金。

虚拟机在云计算中使用的也非常广泛。云厂商，例如AWS，不想直接出借物理服务器给用户，因为这很难管理。它们想向用户出借的是可以随意确定不同规格的服务器。或许有两个用户在一台物理服务器上，但是他们并没有太使用计算机，这样AWS可以继续向同一个物理服务器上加入第三或者第四个用户。这样可以不使用额外的资金而获得更高的收益。所以，虚拟机提供了额外的灵活性。虚拟机使用的技术是：我们会将现存的操作系统内核，从内核空间上移至用户空间，并在之下增加新的一层（注，也就是虚拟机的内核是运行在物理服务器的用户空间，但是在对接物理服务器的内核空间时，是通过新增的一层VMM来对接的）以提供这里的灵活性。

还有一些其他的原因会使得人们使用虚拟机。第一个是开发内核，这就是为什么我们在课程中一直使用QEMU。能够在虚拟环境而不是一个真实的计算机运行XV6，使得这门课程对于我们来说都要方便的多，同时对于调试也更容易，因为相比在物理计算机上运行XV6，在QEMU提供的虚拟机环境中运行可以更容易的提供gdb的访问权限。

最后一个人们使用虚拟机的原因是，通过新增的VMM提供的抽象可以实现许多功能。例如，你可以为整个操作系统和其中的用户进程做一个快照，并在磁盘中保存下来。稍后再恢复快照，并将操作系统和其中的用户进程恢复成做快照时的状态。这可以增加运行的可靠性，或者用来调试，或者用来拷贝虚拟机的镜像并运行多次。除此之外，你可以将一个Guest操作系统迁移到另一个计算机上。如果你在一个物理计算机上运行了一个Guest操作系统，现在需要关闭并替换该物理计算机，你可以在不干扰虚拟机运行的前提下，将它迁移到另一个物理计算机，这样你就可以安全的关闭第一个物理计算机。

以上就是人们喜欢使用虚拟机的原因。虚拟机实际上也应用的非常非常广泛，并且它也有着很长的历史。虚拟机最早出现在1960年代，经过了一段时间的开发才变得非常流行且易用。

对于这么课程来说，我们之所以要学习虚拟机是因为VMM提供了对于操作系统的一种不同视角。基于VMM的结构类似于操作系统的结构，但是这里的结构在上层提供的是一种不同的容器，这种容器并不是我们都熟悉的进程，而是一种对于计算机的模拟。所以它使得我们可以从另一个角度重新审视我们讨论过的内容，例如内存分配，线程调度，或许可以给我们一些新的思路并带回到传统的操作系统内核中。

虚拟机的场景下，大部分的开发设计研究工作，从传统的内核移到了VMM。某种程度上来说，操作系统的内容下移了一层到了VMM。

