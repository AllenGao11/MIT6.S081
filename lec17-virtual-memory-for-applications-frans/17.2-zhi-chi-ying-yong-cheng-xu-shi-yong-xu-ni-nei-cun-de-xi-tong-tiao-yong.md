# 17.2 支持应用程序使用虚拟内存的系统调用

第一个或许也是最重要的一个，是一个叫做mmap的系统调用。它接收某个对象，并将其映射到调用者的地址空间中。举个例子，如果你想映射一个文件，那么你需要将文件描述符传递给mmap系统调用。mmap系统调用有许多令人眼花缭乱的参数：

* 第一个参数是一个你想映射到的特定地址，如果传入null表示不指定特定地址，这样的话内核会选择一个地址来完成映射，并从系统调用返回。
* 第二个参数是长度len。
* 第三个参数是Protection bit，例如读写R\|W。
* 第四个参数是map private，你需要指定如果你写了传入的对象，会发生什么。我们会跳过这一段。
* 第五个参数是传入的对象，在这里就是文件描述符。
* 第六个参数是offset。

![](../.gitbook/assets/image%20%28753%29.png)

通过上面的系统调用，将文件描述符指向的文件内容，增加offset之后的len长度，映射到特定的内存地址（如果指定了的话）。这使得你可以实现Memory Mapped File，你可以将文件的内容带到内存地址空间，进而只需要方便的通过普通的指针操作，而不用调用read/write系统调用，就可以将文件内容写回到磁盘中。所以这是一个方便的接口，可以用来操纵存储在文件中的数据结构。实际上，你们将会在下个lab实现基于文件的mmap，下个lab结合了XV6的文件系统和虚拟内存，进而实现mmap。

mmap还可以用作他途。除了可以映射文件之外，还可以用来映射匿名的内存（Anonymous Memory）。这是sbreak的替代方案，你可以向内核申请物理内存，然后映射到特定的虚拟内存地址。这是实现应用程序虚拟内存的核心系统调用之一，我们稍后会将它与之前提到的特性关联起来。

除此之外，还需要有一些系统调用来支持论文中讨论到的特性。

mprotect系统调用。当你将某个对象映射到了虚拟内存地址空间，你可以修改对应虚拟内存的权限，这样你就可以以特定的权限保护对象的一部分，或者整个对象。

![](../.gitbook/assets/image%20%28751%29.png)

举个例子，使用了mprotect之后，load指令还能执行，但是store指令将会变成Page Fault。类似的，如果你想要将地址空间的一段变成完成不可访问的，那么可以在mprotect中的权限参数传入None，那么任何访问该段地址空间，也就是从addr开始到addr+len结束，都会生成Page Fault。

对应mmap还有一个系统调用unmap，它使得你可以移除映射关系，或者一个地址段。如果你好奇这里是怎么工作的，你应该查看这些系统调用的man page。

![](../.gitbook/assets/image%20%28762%29.png)

最后一个系统调用是sigaction，这是一个signal handler，它使得应用程序可以设置好一旦特定的signal发生了，就调用特定的函数。可以给它传入函数f，作为特定signal的handler。在Page Fault的场景下，生成的signal是segfault。你或许之前在用户代码中看过了segfault，通常来说当发生segfault时，应用程序会停止运行并crash。但是如果应用程序为segfault signal设置了handler，发生segfault时，应用程序不会停止，相应的handler会被内核调用，然后应用程序可以在handler中响应segfault。

当内核发现Page Fault时，或许会修复Page Table这样程序还能继续执行。与内核响应Page Fault的方式类似，在这里的handler中或许会调用mprotect来修改内存的权限，这样指令就可以恢复运行。

![](../.gitbook/assets/image%20%28761%29.png)

与sigaction类似的有sigalarm，在sigalarm中可以设置每隔一段时间就调用的handler。sigaction也可以实现这个功能，只是它更加的通用，因为可以响应不同类型的signal。

> 学生提问：看起来mprotect暗示了你可以为单独的地址添加不同的权限，然而在XV6中，我们只能为整个Page设置相同的权限，这里是有区别吗？
>
> Frans教授：不，这里并没有区别，它们都在Page粒度工作。如果你好奇的话，有一个单独的系统调用可以查看Page的大小。

如果你回想论文中提到的特性，我们可以将它们对应到当前的Unix提供的功能中。 

* trap对应的是sigaction系统调用
* Prot1，ProtN和Unprot可以使用mprotect系统调用来实现。mprotect足够的灵活，你可以用它来修改一个Page的权限，也可以用它来修改多个Page的权限。当修改多个Page的权限时，可以获得只清除一次TLB的好处。
* 查看Page的Dirty位要稍微复杂点，并没有一个直接的系统调用实现这个特性，不过你可以使用一些技巧完成它，我稍后会介绍它。
* map2也没有一个系统调用能直接对应它，通过多次调用mmap，你可以实现map2特性。

或许并不完全受这篇论文所驱动，但是内核开发人员已经为现在的应用程序提供了这些特性。接下来，我将在框架层面简单介绍一下实现，之后再看看应用程序是如何使用这些特性。

